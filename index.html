<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ton City üíé</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root {
    --primary: #facc15;
    --bg: #0b0f1a;
    --card: #161d2f;
    --accent: #38bdf8;
    --green: #4ade80;
    --orange: #fb923c;
    --pink: #f472b6;
}
body {
    margin:0;
    font-family: 'Segoe UI', sans-serif;
    background: radial-gradient(circle at top,#0f172a,#020617);
    color:white;
    overflow-x:hidden;
}
.header{
    text-align:center;
    padding:14px;
}
.balance{
    font-size:44px;
    font-weight:800;
}
.rate{
    color:var(--green);
    font-weight:600;
    margin-top:4px;
}
.central{
    margin:12px;
    background:linear-gradient(145deg,#0b1225,#020617);
    border-radius:22px;
    padding:18px;
    border:2px solid var(--primary);
    box-shadow:0 0 25px rgba(250,204,21,.25);
    text-align:center;
    cursor:pointer;
}
.central i{
    font-size:48px;
    color:var(--primary);
}
.central h2{
    margin:6px 0;
}
.central small{
    color:#94a3b8;
}
.grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
    padding:12px;
}
.card{
    background: linear-gradient(145deg,#0b1225,#020617);
    border-radius:18px;
    padding:14px;
    border:1px solid rgba(255,255,255,.06);
    box-shadow:0 0 15px rgba(0,0,0,.7);
    cursor:pointer;
    transition:.15s;
    text-align:center;
}
.card:hover{
    transform:scale(1.04);
}
.card i{
    font-size:34px;
    margin-bottom:6px;
}
.card h3{
    margin:4px 0;
}
.green{color:var(--green)}
.blue{color:var(--accent)}
.orange{color:var(--orange)}
.pink{color:var(--pink)}
.yellow{color:var(--primary)}
.overlay,.modal{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    display:none;
}
.overlay{
    background:rgba(0,0,0,.7);
    z-index:10;
}
.modal{
    z-index:11;
    background:#020617;
    border-radius:22px;
    padding:20px;
    max-width:380px;
    margin:auto;
    inset:0;
    height:max-content;
    max-height: 80vh;
    overflow-y: auto;
}
.stat{
    display:flex;
    justify-content:space-between;
    padding:8px 12px;
    background:#020617;
    border-radius:10px;
    margin:6px 0;
    border:1px solid rgba(255,255,255,.05);
}
button{
    width:100%;
    padding:12px;
    border-radius:14px;
    border:none;
    background:#2563eb;
    color:white;
    font-weight:700;
    font-size:15px;
    cursor:pointer;
    margin-top:6px;
}
button:disabled{
    background:#334155;
}
.close{
    background:#dc2626;
    margin-top:10px;
}
.nav-bar{
    position:fixed;
    bottom:0;
    width:100%;
    background:#0f172a;
    display:flex;
    justify-content:space-around;
    padding:10px 0;
    border-top:1px solid #1e293b;
}
.nav-item{
    text-align:center;
    font-size:0.7rem;
    color:#94a3b8;
    font-weight:bold;
    cursor:pointer;
    padding:5px;
    border-radius:8px;
    transition:0.2s;
}
.nav-item:hover{
    background:#1e293b;
}
.nav-item img{
    width:22px;
    display:block;
    margin:0 auto 5px;
}
#ton-connect-container {
    margin: 15px 0;
    text-align: center;
}
.hidden {
    display: none !important;
}
.referral-code {
    background: #0f172a;
    padding: 12px;
    border-radius: 12px;
    text-align: center;
    margin: 15px 0;
    border: 1px solid #38bdf8;
}
.referral-code code {
    font-size: 1.2rem;
    font-weight: bold;
    color: #facc15;
    letter-spacing: 1px;
}
.copy-btn {
    background: #10b981 !important;
    margin-top: 10px;
}
.input-group {
    margin: 15px 0;
}
.input-group input {
    width: 100%;
    padding: 14px;
    border-radius: 12px;
    background: #0f172a;
    border: 1px solid #334155;
    color: white;
    font-size: 16px;
    box-sizing: border-box;
}
.info-text {
    color: #94a3b8;
    font-size: 0.9rem;
    margin: 5px 0 15px 0;
}
</style>
</head>
<body>

<div class="header">
    <div>@<span id="user-display">Cargando...</span></div>
    <div class="balance"><span id="diamonds">0</span> üíé</div>
    <div class="rate">+ <span id="rate">0</span> / hr</div>
</div>

<div class="central" onclick="openCentral()">
    <i class="fa-solid fa-city"></i>
    <h2>Edificio Central</h2>
    <small>Estad√≠sticas generales</small>
</div>

<div class="grid">
    <div class="card yellow" onclick="openBank()">
        <i class="fa-solid fa-building-columns"></i>
        <h3>Banco</h3>
        <small>Comprar TON ‚Üí üíé</small>
    </div>
    <div class="card green" onclick="openStore()">
        <i class="fa-solid fa-cart-shopping"></i>
        <h3>Tienda</h3>
        <small>Mejoras</small>
    </div>
    <div class="card orange" onclick="openCentral()">
        <i class="fa-solid fa-dice"></i>
        <h3>Casino</h3>
        <small>Lvl: <span id="lvl_casino">0</span></small>
    </div>
    <div class="card blue" onclick="openCentral()">
        <i class="fa-solid fa-water-ladder"></i>
        <h3>Piscina</h3>
        <small>Lvl: <span id="lvl_piscina">0</span></small>
    </div>
    <div class="card green" onclick="openCentral()">
        <i class="fa-solid fa-tree"></i>
        <h3>Parque</h3>
        <small>Lvl: <span id="lvl_parque">0</span></small>
    </div>
    <div class="card pink" onclick="openCentral()">
        <i class="fa-solid fa-gamepad"></i>
        <h3>Diversi√≥n</h3>
        <small>Lvl: <span id="lvl_diversion">0</span></small>
    </div>
</div>

<!-- MODALES -->
<div class="overlay" id="overlay" onclick="closeAll()"></div>

<div class="modal" id="centralModal">
    <h3>üèõ Edificio Central</h3>
    <div class="stat"><span>Tienda</span><span id="s_tienda">0</span></div>
    <div class="stat"><span>Casino</span><span id="s_casino">0</span></div>
    <div class="stat"><span>Piscina</span><span id="s_piscina">0</span></div>
    <div class="stat"><span>Parque</span><span id="s_parque">0</span></div>
    <div class="stat"><span>Diversi√≥n</span><span id="s_diversion">0</span></div>
    <div class="stat" style="background:#022c22"><b>Total / hr</b><b id="s_total">0</b></div>
    <button class="close" onclick="closeAll()">Cerrar</button>
</div>

<!-- MODAL DEL BANCO -->
<div class="modal" id="modalBank">
    <h3>üè¶ Banco TON</h3>
    <div id="ton-connect-container">
        <div id="ton-connect-button"></div>
        <div id="wallet-info" class="hidden">
            <p>Conectado: <span id="wallet-address"></span></p>
            <button onclick="tonConnectUI.disconnect()">Desconectar</button>
        </div>
    </div>
    <div id="purchase-section" class="hidden">
        <p style="text-align: center; margin-bottom: 15px; color: var(--green);">Selecciona la cantidad a comprar:</p>
        <div id="bankList"></div>
    </div>
    <button class="close" onclick="closeAll()">Cerrar</button>
</div>

<!-- MODAL DE LA TIENDA -->
<div class="modal" id="modalStore">
    <h3>üõí Tienda de Mejoras</h3>
    <div id="storeList"></div>
    <button class="close" onclick="closeAll()">Cerrar</button>
</div>

<!-- MODAL DE AMIGOS (NUEVO) -->
<div class="modal" id="modalFriends">
    <h3>üë• Sistema de Amigos</h3>
    <div class="referral-code">
        <p>Tu c√≥digo de referencia:</p>
        <code id="referral-code">CARGANDO...</code>
        <button class="copy-btn" onclick="copyReferralCode()">üìã Copiar C√≥digo</button>
    </div>
    <div class="stat"><span>Amigos referidos</span><span id="ref-count">0</span></div>
    <div class="stat"><span>Ganancias por referidos</span><span id="ref-earnings">0 üíé</span></div>
    <div class="stat" style="background:#0f172a"><span>Total ganado (10%)</span><span id="ref-total">0 üíé</span></div>
    <p class="info-text">Ganas el 10% de los diamantes que produzcan tus amigos referidos.</p>
    <button class="close" onclick="closeAll()">Cerrar</button>
</div>

<!-- MODAL DE RETIRO (NUEVO) -->
<div class="modal" id="modalWithdraw">
    <h3>üí∞ Retirar TON</h3>
    <div class="stat">
        <span>Precio actual</span>
        <span id="current-price">0 TON/üíé</span>
    </div>
    <div class="stat">
        <span>Tus diamantes</span>
        <span id="available-diamonds">0 üíé</span>
    </div>
    <div class="input-group">
        <input type="number" id="withdraw-amount" placeholder="Cantidad de üíé a retirar" min="1">
        <p class="info-text">Recibir√°s: <span id="ton-receive">0</span> TON</p>
    </div>
    <button onclick="processWithdraw()" id="withdraw-btn">Retirar TON</button>
    <button class="close" onclick="closeAll()">Cancelar</button>
</div>

<!-- BARRA INFERIOR SIMPLIFICADA -->
<div class="nav-bar">
    <div class="nav-item" onclick="openFriends()">
        <img src="https://cdn-icons-png.flaticon.com/512/1216/1216712.png"> AMIGOS
    </div>
    <div class="nav-item" onclick="openWithdraw()">
        <img src="https://cdn-icons-png.flaticon.com/512/2611/2611110.png"> RETIRAR
    </div>
</div>

<script>
// =======================
// VARIABLES GLOBALES Y CONFIGURACI√ìN
// =======================
const tg = window.Telegram.WebApp;
const MI_BILLETERA = "UQB9UHu9CB6usvZOKTZzCYx5DPcSlxKSxKaqo9UMF59t3BVw";
const SUPABASE_URL = 'https://xkkifqxxglcuyruwkbih.supabase.co';
const SUPABASE_KEY = 'sb_publishable_4vyBOxq_vIumZ4EcXyNlsw_XPbJ2iKE';
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Configuraci√≥n de TON Connect
const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
    manifestUrl: 'https://nyper95.github.io/ton-city-game/tonconnect-manifest.json',
    buttonRootId: 'ton-connect-button',
    uiPreferences: { theme: 'DARK' }
});

// Estado del usuario
let userData = {
    id: null,
    diamonds: 0,
    lvl_tienda: 0,
    lvl_casino: 0,
    lvl_piscina: 0,
    lvl_parque: 0,
    lvl_diversion: 0,
    referral_code: null,
    referred_by: null,
    referral_earnings: 0
};

// Config econom√≠a
const USER_SHARE = 0.8; // 80% para el pool de usuarios
const OWNER_SHARE = 0.2; // 20% para ti

// Producci√≥n por edificio por nivel (diamantes/hr)
const PROD_VAL = { 
    tienda: 10, 
    casino: 25, 
    piscina: 60, 
    parque: 15, 
    diversion: 120, 
    banco: 5 
};

// Referencias globales
let globalPool = { pool_ton: 100, total_diamonds: 100000 }; // Valores por defecto

// =======================
// INICIALIZACI√ìN DE TON CONNECT
// =======================
tonConnectUI.onStatusChange((wallet) => {
    updateWalletUI(wallet);
    if (wallet && document.getElementById('modalBank').style.display === 'block') {
        openBank();
    }
});

function updateWalletUI(wallet) {
    const connectContainer = document.getElementById('ton-connect-container');
    const purchaseSection = document.getElementById('purchase-section');
    const walletInfo = document.getElementById('wallet-info');
    const walletAddress = document.getElementById('wallet-address');
    
    if (wallet) {
        document.getElementById('ton-connect-button').classList.add('hidden');
        walletInfo.classList.remove('hidden');
        const shortAddress = wallet.address.substring(0, 6) + '...' + wallet.address.substring(wallet.address.length - 4);
        walletAddress.textContent = shortAddress;
        purchaseSection.classList.remove('hidden');
    } else {
        document.getElementById('ton-connect-button').classList.remove('hidden');
        walletInfo.classList.add('hidden');
        purchaseSection.classList.add('hidden');
    }
}

// =======================
// FUNCIONES PRINCIPALES
// =======================
async function getGlobalPool() {
    try {
        let { data } = await _supabase.from("global").select("*").single();
        if (data) {
            globalPool = data;
            return data;
        }
    } catch (error) {
        console.error("Error cargando pool global:", error);
    }
    return globalPool;
}

async function updateGlobalPool(newTon, newDiamonds) {
    await _supabase.from("global").update({
        pool_ton: newTon,
        total_diamonds: newDiamonds
    }).eq("id", 1);
}

function calcPrice(pool) {
    if (!pool || pool.total_diamonds <= 0) return 0.001;
    return (pool.pool_ton * USER_SHARE) / pool.total_diamonds;
}

async function sendTon(amount, to) {
    const tx = {
        validUntil: Math.floor(Date.now() / 1000) + 600,
        messages: [{
            address: to,
            amount: (amount * 1e9).toString()
        }]
    };
    return await tonConnectUI.sendTransaction(tx);
}

async function comprarTON(ton) {
    const wallet = tonConnectUI.wallet;
    if (!wallet) {
        alert("Por favor, conecta tu billetera TON primero.");
        return;
    }
    
    const pool = await getGlobalPool();
    const price = calcPrice(pool);
    const userTon = ton * USER_SHARE;
    const diamonds = Math.floor(userTon / price);

    await sendTon(ton, MI_BILLETERA);

    userData.diamonds += diamonds;

    await _supabase.from("usuarios").update({ diamonds: userData.diamonds })
        .eq("telegram_id", userData.id);

    await updateGlobalPool(pool.pool_ton + userTon, pool.total_diamonds + diamonds);

    actualizarUI();
    openBank();
}

async function retirarTON(diamonds) {
    const wallet = tonConnectUI.wallet;
    if (!wallet) {
        alert("Por favor, conecta tu billetera TON primero.");
        return;
    }
    
    const pool = await getGlobalPool();
    const price = calcPrice(pool);
    const tonAmount = diamonds * price;

    if (tonAmount > pool.pool_ton) {
        alert("Liquidez insuficiente en el pool.");
        return;
    }

    if (diamonds > userData.diamonds) {
        alert("No tienes suficientes diamantes.");
        return;
    }

    userData.diamonds -= diamonds;

    await sendTon(tonAmount, wallet.address);

    await _supabase.from("usuarios").update({ diamonds: userData.diamonds })
        .eq("telegram_id", userData.id);

    await updateGlobalPool(pool.pool_ton - tonAmount, pool.total_diamonds - diamonds);

    actualizarUI();
    alert(`¬°Retiro exitoso! Has recibido ${tonAmount.toFixed(4)} TON.`);
}

// =======================
// SISTEMA DE REFERIDOS
// =======================
async function loadUser(user) {
    userData.id = user.id.toString();
    
    // Generar c√≥digo de referencia √∫nico
    const referralCode = 'REF' + user.id.toString().slice(-6);
    userData.referral_code = referralCode;

    let { data } = await _supabase.from('usuarios')
        .select('*').eq('telegram_id', userData.id).single();

    if (!data) {
        // Verificar si hay un c√≥digo de referencia en la URL
        const urlParams = new URLSearchParams(window.location.search);
        const refCode = urlParams.get('ref');
        
        await _supabase.from('usuarios').insert([{
            telegram_id: userData.id,
            username: user.username,
            diamonds: 100, // Bonificaci√≥n inicial
            referral_code: referralCode,
            referred_by: refCode || null
        }]);
        
        userData.diamonds = 100;
        
        // Si fue referido, dar bonificaci√≥n al referidor
        if (refCode) {
            await addReferralBonus(refCode, 50); // 50 diamantes al referidor
        }
    } else {
        userData.diamonds = data.diamonds || 0;
        userData.lvl_tienda = data.lvl_tienda || 0;
        userData.lvl_casino = data.lvl_casino || 0;
        userData.lvl_piscina = data.lvl_piscina || 0;
        userData.lvl_parque = data.lvl_parque || 0;
        userData.lvl_diversion = data.lvl_diversion || 0;
        userData.referral_code = data.referral_code || referralCode;
        userData.referred_by = data.referred_by || null;
        userData.referral_earnings = data.referral_earnings || 0;
    }

    document.getElementById("user-display").innerText = user.username || "Usuario";
    actualizarUI();
    updateReferralStats();
}

async function addReferralBonus(referralCode, bonus) {
    try {
        // Encontrar al referidor
        let { data: referrer } = await _supabase.from('usuarios')
            .select('telegram_id, diamonds, referral_earnings')
            .eq('referral_code', referralCode)
            .single();
            
        if (referrer) {
            // Agregar bonificaci√≥n (10% de lo que gana el referido)
            const earnings = Math.floor(bonus * 0.1);
            await _supabase.from('usuarios')
                .update({
                    diamonds: referrer.diamonds + earnings,
                    referral_earnings: (referrer.referral_earnings || 0) + earnings
                })
                .eq('telegram_id', referrer.telegram_id);
        }
    } catch (error) {
        console.error("Error a√±adiendo bonificaci√≥n:", error);
    }
}

async function updateReferralStats() {
    if (!userData.id) return;
    
    try {
        // Contar referidos directos
        let { count } = await _supabase.from('usuarios')
            .select('*', { count: 'exact', head: true })
            .eq('referred_by', userData.referral_code);
        
        // Obtener ganancias totales por referidos
        let { data } = await _supabase.from('usuarios')
            .select('referral_earnings')
            .eq('telegram_id', userData.id)
            .single();
            
        const earnings = data?.referral_earnings || 0;
        
        // Actualizar UI
        document.getElementById("ref-count").textContent = count || 0;
        document.getElementById("ref-earnings").textContent = `${earnings} üíé`;
        document.getElementById("ref-total").textContent = `${earnings} üíé`;
        document.getElementById("referral-code").textContent = userData.referral_code;
        
    } catch (error) {
        console.error("Error actualizando stats de referidos:", error);
    }
}

// =======================
// INTERFAZ DE USUARIO
// =======================
function actualizarUI() {
    document.getElementById("diamonds").innerText = Math.floor(userData.diamonds).toLocaleString();

    const totalPerHr = userData.lvl_tienda * PROD_VAL.tienda +
                       userData.lvl_casino * PROD_VAL.casino +
                       userData.lvl_piscina * PROD_VAL.piscina +
                       userData.lvl_parque * PROD_VAL.parque +
                       userData.lvl_diversion * PROD_VAL.diversion +
                       PROD_VAL.banco;

    document.getElementById("rate").innerText = totalPerHr;
    
    document.getElementById("lvl_casino").innerText = userData.lvl_casino;
    document.getElementById("lvl_piscina").innerText = userData.lvl_piscina;
    document.getElementById("lvl_parque").innerText = userData.lvl_parque;
    document.getElementById("lvl_diversion").innerText = userData.lvl_diversion;
}

function startProduction() {
    setInterval(async () => {
        const prod = {
            tienda: userData.lvl_tienda * PROD_VAL.tienda / 3600,
            casino: userData.lvl_casino * PROD_VAL.casino / 3600,
            piscina: userData.lvl_piscina * PROD_VAL.piscina / 3600,
            parque: userData.lvl_parque * PROD_VAL.parque / 3600,
            diversion: userData.lvl_diversion * PROD_VAL.diversion / 3600,
            banco: PROD_VAL.banco / 3600
        };

        const total = prod.tienda + prod.casino + prod.piscina + prod.parque + prod.diversion + prod.banco;
        userData.diamonds += total;

        // Guardar diamantes cada 30 segundos
        if (Math.floor(Date.now() / 1000) % 30 === 0) {
            await _supabase.from('usuarios')
                .update({ diamonds: userData.diamonds })
                .eq('telegram_id', userData.id);
        }

        actualizarUI();

        if (document.getElementById("centralModal").style.display === "block") {
            document.getElementById("s_tienda").innerText = Math.floor(prod.tienda * 3600);
            document.getElementById("s_casino").innerText = Math.floor(prod
