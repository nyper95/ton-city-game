<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ton City üíé</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root {
    --primary: #facc15;
    --bg: #0b0f1a;
    --card: #161d2f;
    --accent: #38bdf8;
    --green: #4ade80;
    --orange: #fb923c;
    --pink: #f472b6;
}
body {
    margin:0;
    font-family: 'Segoe UI', sans-serif;
    background: radial-gradient(circle at top,#0f172a,#020617);
    color:white;
    overflow-x:hidden;
}
.header{
    text-align:center;
    padding:14px;
}
.balance{
    font-size:44px;
    font-weight:800;
}
.rate{
    color:var(--green);
    font-weight:600;
    margin-top:4px;
}
.central{
    margin:12px;
    background:linear-gradient(145deg,#0b1225,#020617);
    border-radius:22px;
    padding:18px;
    border:2px solid var(--primary);
    box-shadow:0 0 25px rgba(250,204,21,.25);
    text-align:center;
    cursor:pointer;
}
.central i{
    font-size:48px;
    color:var(--primary);
}
.central h2{
    margin:6px 0;
}
.central small{
    color:#94a3b8;
}
.grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
    padding:12px;
}
.card{
    background: linear-gradient(145deg,#0b1225,#020617);
    border-radius:18px;
    padding:14px;
    border:1px solid rgba(255,255,255,.06);
    box-shadow:0 0 15px rgba(0,0,0,.7);
    cursor:pointer;
    transition:.15s;
    text-align:center;
}
.card:hover{
    transform:scale(1.04);
}
.card i{
    font-size:34px;
    margin-bottom:6px;
}
.card h3{
    margin:4px 0;
}
.green{color:var(--green)}
.blue{color:var(--accent)}
.orange{color:var(--orange)}
.pink{color:var(--pink)}
.yellow{color:var(--primary)}
.overlay,.modal{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    display:none;
}
.overlay{
    background:rgba(0,0,0,.7);
    z-index:10;
}
.modal{
    z-index:11;
    background:#020617;
    border-radius:22px;
    padding:20px;
    max-width:380px;
    margin:auto;
    inset:0;
    height:max-content;
    max-height: 80vh; /* Altura m√°xima para que haga scroll si es necesario */
    overflow-y: auto; /* Permite desplazamiento vertical dentro del modal */
}
.stat{
    display:flex;
    justify-content:space-between;
    padding:8px 12px;
    background:#020617;
    border-radius:10px;
    margin:6px 0;
    border:1px solid rgba(255,255,255,.05);
}
button{
    width:100%;
    padding:12px;
    border-radius:14px;
    border:none;
    background:#2563eb;
    color:white;
    font-weight:700;
    font-size:15px;
    cursor:pointer;
    margin-top:6px;
}
button:disabled{
    background:#334155;
}
.close{
    background:#dc2626;
    margin-top:10px;
}
.nav-bar{
    position:fixed;
    bottom:0;
    width:100%;
    background:#0f172a;
    display:flex;
    justify-content:space-around;
    padding:10px 0;
    border-top:1px solid #1e293b;
}
.nav-item{
    text-align:center;
    font-size:0.7rem;
    color:#94a3b8;
    font-weight:bold;
}
.nav-item img{
    width:22px;
    display:block;
    margin:0 auto 5px;
}

/* Estilo espec√≠fico para el contenedor del bot√≥n TON Connect dentro del modal */
#ton-connect-container {
    margin: 15px 0;
    text-align: center;
}

/* Estilo para el bot√≥n del modal (cuando se usa un bot√≥n normal) */
.ton-connect-btn {
    background: linear-gradient(135deg, #007bff, #6610f2);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 12px;
    font-weight: bold;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}
.ton-connect-btn:hover {
    background: linear-gradient(135deg, #0056b3, #520dc2);
}

/* Clase para ocultar elementos */
.hidden {
    display: none !important;
}
</style>
</head>
<body>

<div class="header">
    <div>@<span id="user-display">Cargando...</span></div>
    <div class="balance"><span id="diamonds">0</span> üíé</div>
    <div class="rate">+ <span id="rate">0</span> / hr</div>
    <!-- El bot√≥n de TON Connect ya NO est√° aqu√≠ -->
</div>

<div class="central" onclick="openCentral()">
    <i class="fa-solid fa-city"></i>
    <h2>Edificio Central</h2>
    <small>Estad√≠sticas generales</small>
</div>

<div class="grid">
    <div class="card yellow" onclick="openBank()">
        <i class="fa-solid fa-building-columns"></i>
        <h3>Banco</h3>
        <small>Comprar TON ‚Üí üíé</small>
    </div>
    <div class="card green" onclick="openStore()">
        <i class="fa-solid fa-cart-shopping"></i>
        <h3>Tienda</h3>
        <small>Mejoras</small>
    </div>
    <div class="card orange">
        <i class="fa-solid fa-dice"></i>
        <h3>Casino</h3>
        <small>Lvl: <span id="lvl_casino">0</span></small>
    </div>
    <div class="card blue">
        <i class="fa-solid fa-water-ladder"></i>
        <h3>Piscina</h3>
        <small>Lvl: <span id="lvl_piscina">0</span></small>
    </div>
    <div class="card green">
        <i class="fa-solid fa-tree"></i>
        <h3>Parque</h3>
        <small>Lvl: <span id="lvl_parque">0</span></small>
    </div>
    <div class="card pink">
        <i class="fa-solid fa-gamepad"></i>
        <h3>Diversi√≥n</h3>
        <small>Lvl: <span id="lvl_diversion">0</span></small>
    </div>
</div>

<!-- MODALES -->
<div class="overlay" id="overlay" onclick="closeAll()"></div>

<div class="modal" id="centralModal">
    <h3>üèõ Edificio Central</h3>
    <div class="stat"><span>Tienda</span><span id="s_tienda">0</span></div>
    <div class="stat"><span>Casino</span><span id="s_casino">0</span></div>
    <div class="stat"><span>Piscina</span><span id="s_piscina">0</span></div>
    <div class="stat"><span>Parque</span><span id="s_parque">0</span></div>
    <div class="stat"><span>Diversi√≥n</span><span id="s_diversion">0</span></div>
    <div class="stat" style="background:#022c22"><b>Total / hr</b><b id="s_total">0</b></div>
    <button class="close" onclick="closeAll()">Cerrar</button>
</div>

<!-- MODAL DEL BANCO (con el bot√≥n de TON Connect) -->
<div class="modal" id="modalBank">
    <h3>üè¶ Banco TON</h3>
    <!-- Contenedor para el bot√≥n de TON Connect -->
    <div id="ton-connect-container">
        <div id="ton-connect-button"></div>
        <!-- Elemento para mostrar informaci√≥n de la billetera cuando est√© conectada -->
        <div id="wallet-info" class="hidden">
            <p>Conectado: <span id="wallet-address"></span></p>
            <button onclick="tonConnectUI.disconnect()">Desconectar</button>
        </div>
    </div>
    <!-- Secci√≥n de compras (inicialmente oculta hasta que el usuario conecte) -->
    <div id="purchase-section" class="hidden">
        <p style="text-align: center; margin-bottom: 15px; color: var(--green);">Selecciona la cantidad a comprar:</p>
        <div id="bankList"></div>
        <button onclick="retirar()">üíé Retirar a TON</button>
    </div>
    <button class="close" onclick="closeAll()">Cerrar</button>
</div>

<div class="modal" id="modalStore">
    <h3>üõí Tienda de Mejoras</h3>
    <div id="storeList"></div>
    <button class="close" onclick="closeAll()">Cerrar</button>
</div>

<div class="nav-bar">
    <div class="nav-item"><img src="https://cdn-icons-png.flaticon.com/512/1042/1042502.png"> MEJORAS</div>
    <div class="nav-item"><img src="https://cdn-icons-png.flaticon.com/512/1216/1216712.png"> AMIGOS</div>
    <div class="nav-item"><img src="https://cdn-icons-png.flaticon.com/512/2611/2611110.png"> RETIRAR</div>
</div>

<script>
// =======================
// VARIABLES GLOBALES
// =======================
const tg = window.Telegram.WebApp;
const MI_BILLETERA = "UQB9UHu9CB6usvZOKTZzCYx5DPcSlxKSxKaqo9UMF59t3BVw";
const SUPABASE_URL = 'https://xkkifqxxglcuyruwkbih.supabase.co';
const SUPABASE_KEY = 'sb_publishable_4vyBOxq_vIumZ4EcXyNlsw_XPbJ2iKE';
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Configuraci√≥n de TON Connect
// NOTA: Cambia la URL del manifiesto si es necesario
const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
    manifestUrl: 'https://nyper95.github.io/ton-city-game/tonconnect-manifest.json',
    buttonRootId: 'ton-connect-button',
    uiPreferences: {
        theme: 'DARK'
    }
});

// Estado del usuario
let userData = {
    id: null,
    diamonds: 0,
    lvl_tienda: 0,
    lvl_casino: 0,
    lvl_piscina: 0,
    lvl_parque: 0,
    lvl_diversion: 0
};

// Config econom√≠a
const USER_SHARE = 0.8;
const OWNER_SHARE = 0.2;

// Producci√≥n por edificio por nivel (diamantes/hr)
const PROD_VAL = { tienda:10, casino:25, piscina:60, parque:15, diversion:120, banco:5 };

// =======================
// INICIALIZACI√ìN DE TON CONNECT
// =======================
// Escucha cambios en el estado de la conexi√≥n (conectado/desconectado)
tonConnectUI.onStatusChange((wallet) => {
    updateWalletUI(wallet);
    // Si se conecta una billetera y el modal del banco est√° abierto, actualizamos los precios
    if (wallet && document.getElementById('modalBank').style.display === 'block') {
        openBank();
    }
});

// Funci√≥n para actualizar la UI seg√∫n el estado de la billetera
function updateWalletUI(wallet) {
    const connectContainer = document.getElementById('ton-connect-container');
    const purchaseSection = document.getElementById('purchase-section');
    const walletInfo = document.getElementById('wallet-info');
    const walletAddress = document.getElementById('wallet-address');
    
    if (wallet) {
        // Billetera conectada: ocultamos el bot√≥n de conexi√≥n y mostramos la info
        document.getElementById('ton-connect-button').classList.add('hidden');
        walletInfo.classList.remove('hidden');
        
        // Acortamos la direcci√≥n para mostrar
        const shortAddress = wallet.address.substring(0, 6) + '...' + wallet.address.substring(wallet.address.length - 4);
        walletAddress.textContent = shortAddress;
        
        // Mostramos la secci√≥n de compras
        purchaseSection.classList.remove('hidden');
    } else {
        // Billetera desconectada: mostramos el bot√≥n de conexi√≥n
        document.getElementById('ton-connect-button').classList.remove('hidden');
        walletInfo.classList.add('hidden');
        purchaseSection.classList.add('hidden');
    }
}

// =======================
// POOL GLOBAL
// =======================
async function getGlobalPool(){
    let { data } = await _supabase.from("global").select("*").single();
    return data;
}
async function updateGlobalPool(newTon, newDiamonds){
    await _supabase.from("global").update({
        pool_ton: newTon,
        total_diamonds: newDiamonds
    }).eq("id",1);
}

// =======================
// PRECIO DIN√ÅMICO
// =======================
function calcPrice(pool){
    if(pool.total_diamonds <= 0) return 0.001;
    return (pool.pool_ton * USER_SHARE) / pool.total_diamonds;
}

// =======================
// TON CONNECT SEND
// =======================
async function sendTon(amount, to){
    const tx = {
        validUntil: Math.floor(Date.now()/1000)+600,
        messages: [{
            address: to,
            amount: (amount * 1e9).toString()
        }]
    };
    return await tonConnectUI.sendTransaction(tx);
}

// =======================
// COMPRAR DIAMANTES
// =======================
async function comprarTON(ton){
    // Verificar que la billetera est√© conectada
    const wallet = tonConnectUI.wallet;
    if (!wallet) {
        alert("Por favor, conecta tu billetera TON primero.");
        return;
    }
    
    const pool = await getGlobalPool();
    const price = calcPrice(pool);
    const userTon = ton * USER_SHARE;
    const ownerTon = ton * OWNER_SHARE;
    const diamonds = Math.floor(userTon / price);

    await sendTon(ton, MI_BILLETERA);

    userData.diamonds += diamonds;

    await _supabase.from("usuarios").update({ diamonds: userData.diamonds })
        .eq("telegram_id", userData.id);

    await updateGlobalPool(pool.pool_ton + userTon, pool.total_diamonds + diamonds);

    actualizarUI();
    openBank(); // Reabre el banco para actualizar los precios
}

// =======================
// RETIRO
// =======================
async function retirarTON(diamonds){
    // Verificar que la billetera est√© conectada
    const wallet = tonConnectUI.wallet;
    if (!wallet) {
        alert("Por favor, conecta tu billetera TON primero.");
        return;
    }
    
    const pool = await getGlobalPool();
    const price = calcPrice(pool);
    const tonAmount = diamonds * price;

    if(tonAmount > pool.pool_ton){
        alert("Liquidez insuficiente");
        return;
    }

    userData.diamonds -= diamonds;

    await sendTon(tonAmount, tonConnectUI.account.address);

    await _supabase.from("usuarios").update({ diamonds: userData.diamonds })
        .eq("telegram_id", userData.id);

    await updateGlobalPool(pool.pool_ton - tonAmount, pool.total_diamonds - diamonds);

    actualizarUI();
}

// =======================
// CARGA USUARIO
// =======================
async function loadUser(user){
    userData.id = user.id.toString();

    let { data } = await _supabase.from('usuarios')
        .select('*').eq('telegram_id', userData.id).single();

    if(!data){
        await _supabase.from('usuarios').insert([{
            telegram_id: userData.id,
            username: user.username,
            diamonds: 0
        }]);
        userData.diamonds = 0;
    } else {
        userData.diamonds = data.diamonds;
        userData.lvl_tienda = data.lvl_tienda || 0;
        userData.lvl_casino = data.lvl_casino || 0;
        userData.lvl_piscina = data.lvl_piscina || 0;
        userData.lvl_parque = data.lvl_parque || 0;
        userData.lvl_diversion = data.lvl_diversion || 0;
    }

    actualizarUI();
}

// =======================
// UI
// =======================
function actualizarUI(){
    document.getElementById("diamonds").innerText =
        Math.floor(userData.diamonds).toLocaleString();

    // Actualiza producci√≥n por hora
    const totalPerHr = userData.lvl_tienda*PROD_VAL.tienda+
                       userData.lvl_casino*PROD_VAL.casino+
                       userData.lvl_piscina*PROD_VAL.piscina+
                       userData.lvl_parque*PROD_VAL.parque+
                       userData.lvl_diversion*PROD_VAL.diversion+
                       PROD_VAL.banco;

    document.getElementById("rate").innerText = totalPerHr;
    
    // Actualiza niveles en la cuadr√≠cula principal
    document.getElementById("lvl_casino").innerText = userData.lvl_casino;
    document.getElementById("lvl_piscina").innerText = userData.lvl_piscina;
    document.getElementById("lvl_parque").innerText = userData.lvl_parque;
    document.getElementById("lvl_diversion").innerText = userData.lvl_diversion;
}

// =======================
// PRODUCCI√ìN AUTOM√ÅTICA
// =======================
function startProduction(){
    setInterval(() => {
        const prod = {
            tienda: userData.lvl_tienda*PROD_VAL.tienda/3600,
            casino: userData.lvl_casino*PROD_VAL.casino/3600,
            piscina: userData.lvl_piscina*PROD_VAL.piscina/3600,
            parque: userData.lvl_parque*PROD_VAL.parque/3600,
            diversion: userData.lvl_diversion*PROD_VAL.diversion/3600,
            banco: PROD_VAL.banco/3600
        };

        const total = prod.tienda+prod.casino+prod.piscina+prod.parque+prod.diversion+prod.banco;
        userData.diamonds += total;

        actualizarUI();

        // Actualiza modal central si est√° abierto
        if(document.getElementById("centralModal").style.display==="block"){
            document.getElementById("s_tienda").innerText = Math.floor(prod.tienda*3600);
            document.getElementById("s_casino").innerText = Math.floor(prod.casino*3600);
            document.getElementById("s_piscina").innerText = Math.floor(prod.piscina*3600);
            document.getElementById("s_parque").innerText = Math.floor(prod.parque*3600);
            document.getElementById("s_diversion").innerText = Math.floor(prod.diversion*3600);
            document.getElementById("s_total").innerText = Math.floor(total*3600);
        }

    },1000); // cada segundo
}

// =======================
// BANCO EN TIEMPO REAL
// =======================
async function openBank(){
    showModal("modalBank");
    
    // Actualiza la UI de la billetera
    updateWalletUI(tonConnectUI.wallet);
    
    // Solo genera opciones de compra si el usuario tiene una billetera conectada
    if (tonConnectUI.wallet) {
        const pool = await getGlobalPool();
        const price = calcPrice(pool);

        let html = "";
        // Rangos de compra: desde 0.10 TON hasta 10 TON
        const tonOptions = [0.1, 0.5, 1, 2, 5, 10];
        
        tonOptions.forEach(v => {
            const diamonds = Math.floor((v * USER_SHARE) / price);
            html += `
            <div class="stat">
                <span>${v.toFixed(2)} TON</span>
                <span>‚âà ${diamonds} üíé</span>
                <button onclick="comprarTON(${v})">Comprar</button>
            </div>`;
        });
        
        // Mostrar el precio actual (opcional, √∫til para el usuario)
        html = `<div class="stat" style="background:#0f172a; margin-bottom: 15px;">
                  <span><b>Precio actual</b></span>
                  <span><b>${price.toFixed(6)} TON/üíé</b></span>
                </div>` + html;
        
        document.getElementById("bankList").innerHTML = html;
    }
}

// =======================
// TIENDA EN TIEMPO REAL
// =======================
function openStore(){
    const items = [
        {name:"Tienda",lvl:userData.lvl_tienda,price:10},
        {name:"Casino",lvl:userData.lvl_casino,price:20},
        {name:"Piscina",lvl:userData.lvl_piscina,price:30},
        {name:"Parque",lvl:userData.lvl_parque,price:15},
        {name:"Diversi√≥n",lvl:userData.lvl_diversion,price:50}
    ];
    let html = "";
    items.forEach((item,index)=>{
        html += `<div class="stat">
            <span>${item.name} Lvl ${item.lvl}</span>
            <span>${item.price} üíé</span>
            <button onclick="buyUpgrade('${item.name}',${item.price})">Comprar</button>
        </div>`;
    });
    document.getElementById("storeList").innerHTML = html;
    showModal("modalStore");
}

async function buyUpgrade(name,price){
    if(userData.diamonds < price){
        alert("No tienes suficientes üíé");
        return;
    }
    userData.diamonds -= price;
    switch(name){
        case "Tienda": userData.lvl_tienda++; break;
        case "Casino": userData.lvl_casino++; break;
        case "Piscina": userData.lvl_piscina++; break;
        case "Parque": userData.lvl_parque++; break;
        case "Diversi√≥n": userData.lvl_diversion++; break;
    }
    await _supabase.from('usuarios').update({
        diamonds:userData.diamonds,
        lvl_tienda:userData.lvl_tienda,
        lvl_casino:userData.lvl_casino,
        lvl_piscina:userData.lvl_piscina,
        lvl_parque:userData.lvl_parque,
        lvl_diversion:userData.lvl_diversion
    }).eq("telegram_id", userData.id);
    actualizarUI();
    openStore();
}

// =======================
// CENTRAL
// =======================
function openCentral(){
    const prod = {
        tienda: userData.lvl_tienda*PROD_VAL.tienda,
        casino: userData.lvl_casino*PROD_VAL.casino,
        piscina: userData.lvl_piscina*PROD_VAL.piscina,
        parque: userData.lvl_parque*PROD_VAL.parque,
        diversion: userData.lvl_diversion*PROD_VAL.diversion,
        banco: PROD_VAL.banco
    };
    const total = prod.tienda+prod.casino+prod.piscina+prod.parque+prod.diversion+prod.banco;

    document.getElementById("s_tienda").innerText=prod.tienda;
    document.getElementById("s_casino").innerText=prod.casino;
    doc
